{% extends 'articles/base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Edit{% else %}Build{% endif %} Sankey Diagram{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-diagram-3"></i> {% if is_edit %}Edit{% else %}Build{% endif %} Sankey Diagram</h2>
            <a href="{% url 'sankey_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
</div>

<!-- Save Form -->
<div class="card mb-3 border-success">
    <div class="card-header bg-success text-white">
        <i class="bi bi-save"></i> Save Diagram
    </div>
    <div class="card-body">
        <form method="post" id="save-diagram-form">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="diagram-name" class="form-label">Diagram Name *</label>
                    <input type="text" class="form-control" id="diagram-name" name="name"
                           value="{{ diagram.name|default:'' }}" required
                           placeholder="Enter diagram name">
                </div>
                <div class="col-md-5">
                    <label for="diagram-description" class="form-label">Description</label>
                    <input type="text" class="form-control" id="diagram-description" name="description"
                           value="{{ diagram.description|default:'' }}"
                           placeholder="Optional description">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
            <input type="hidden" id="config-text-input" name="config_text" value="">
            <input type="hidden" id="settings-json-input" name="settings_json" value="{}">
        </form>
    </div>
</div>

<!-- Diagram Builder -->
<div class="row g-0">
    <!-- Left Column: Editor (20%) -->
    <div class="col-12 col-xl-2" style="border-right: 2px solid #dee2e6; height: calc(100vh - 200px); overflow-y: auto;">
        <div class="p-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted"><i class="bi bi-pencil-square"></i> Configuration</small>
                <button type="button" class="btn btn-xs btn-link p-0" data-bs-toggle="collapse" data-bs-target="#syntaxHelp">
                    <i class="bi bi-question-circle"></i>
                </button>
            </div>
            <div>
                <textarea id="diagram-config" class="form-control font-monospace" rows="30"
                          placeholder="Flow definitions...

Example:
A [100] B
B [60] C

:A #4A90E2"
                          style="resize: vertical; font-size: 11px;">{{ diagram.config_text|default:'' }}</textarea>

                <div class="mt-2">
                    <label class="form-label small">Quick Templates:</label>
                    <div class="d-grid gap-1">
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('simple')">
                            Simple
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('article')">
                            Article
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('budget')">
                            Budget
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-danger btn-sm" onclick="clearConfig()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="collapse mt-2" id="syntaxHelp">
                    <div class="alert alert-info p-2 small">
                        <strong>Syntax:</strong>
                        <ul class="mb-0" style="font-size: 10px; padding-left: 15px;">
                            <li><code>A [100] B</code></li>
                            <li><code>:A #FF6B6B</code></li>
                            <li><code>// Comment</code></li>
                        </ul>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="mt-3">
                    <small class="text-muted"><i class="bi bi-sliders"></i> Settings</small>
                </div>
                <div>
                    <!-- Width Slider -->
                    <div class="mb-3">
                        <label for="diagram-width" class="form-label small mb-1">
                            Width: <span id="width-value">1200</span>px
                        </label>
                        <input type="range" class="form-range" id="diagram-width"
                               min="400" max="2400" step="100" value="1200"
                               oninput="document.getElementById('width-value').textContent = this.value; renderDiagram()">
                    </div>

                    <!-- Height Slider -->
                    <div class="mb-3">
                        <label for="diagram-height" class="form-label small mb-1">
                            Height: <span id="height-value">600</span>px
                        </label>
                        <input type="range" class="form-range" id="diagram-height"
                               min="300" max="2400" step="100" value="600"
                               oninput="document.getElementById('height-value').textContent = this.value; renderDiagram()">
                    </div>

                    <!-- Node Width Slider -->
                    <div class="mb-3">
                        <label for="node-width" class="form-label small mb-1">
                            Node Width: <span id="node-width-value">15</span>px
                        </label>
                        <input type="range" class="form-range" id="node-width"
                               min="1" max="50" step="1" value="15"
                               oninput="document.getElementById('node-width-value').textContent = this.value; renderDiagram()">
                    </div>

                    <!-- Node Padding Slider (affects height) -->
                    <div class="mb-3">
                        <label for="node-padding" class="form-label small mb-1">
                            Node Spacing: <span id="node-padding-value">10</span>px
                        </label>
                        <input type="range" class="form-range" id="node-padding"
                               min="1" max="50" step="1" value="10"
                               oninput="document.getElementById('node-padding-value').textContent = this.value; renderDiagram()">
                    </div>

                    <!-- Show Nodes Toggle -->
                    <div class="mb-2 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="show-nodes" checked onchange="renderDiagram()">
                        <label class="form-check-label small" for="show-nodes">Show Node Bars</label>
                    </div>

                    <!-- Show Labels Toggle -->
                    <div class="mb-2 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="show-labels" checked onchange="renderDiagram()">
                        <label class="form-check-label small" for="show-labels">Show Labels</label>
                    </div>

                    <!-- Label Position -->
                    <div class="mb-3">
                        <label class="form-label small mb-1">Label Position</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="label-position"
                                       id="label-auto" value="auto" checked onchange="renderDiagram()">
                                <label class="form-check-label small" for="label-auto">Auto</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="label-position"
                                       id="label-left" value="left" onchange="renderDiagram()">
                                <label class="form-check-label small" for="label-left">Left</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="label-position"
                                       id="label-right" value="right" onchange="renderDiagram()">
                                <label class="form-check-label small" for="label-right">Right</label>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="renderDiagram()">
                        <i class="bi bi-arrow-clockwise"></i> Update
                    </button>

                    <hr class="my-3">

                    <div class="mb-2">
                        <small class="text-muted"><i class="bi bi-clock-history"></i> Autosave & History</small>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="autosave-enabled" checked onchange="toggleAutosave()">
                        <label class="form-check-label small" for="autosave-enabled">Enable Autosave (30s)</label>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="showHistoryTree()">
                        <i class="bi bi-clock-history"></i> Version History
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="saveSnapshot()">
                        <i class="bi bi-bookmark"></i> Manual Snapshot
                    </button>

                    <hr class="my-3">

                    <div class="mb-2">
                        <small class="text-muted"><i class="bi bi-globe"></i> Publishing</small>
                    </div>
                    {% if diagram.is_published %}
                    <div class="alert alert-success p-2 small mb-2">
                        <i class="bi bi-check-circle"></i> Published<br>
                        <small class="text-muted">{{ diagram.published_at|date:"Y-m-d H:i" }}</small>
                    </div>
                    {% else %}
                    <button type="button" class="btn btn-warning btn-sm w-100" onclick="publishDiagram()" id="publish-btn">
                        <i class="bi bi-globe"></i> Publish Diagram
                    </button>
                    <small class="text-muted d-block mt-1" style="font-size: 10px;">
                        Publishing creates database entries for nodes and enables article associations.
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Preview (80%) -->
    <div class="col-12 col-xl-10">
        <div class="card border-0 rounded-0" style="height: calc(100vh - 200px);">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-eye"></i> Live Preview</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadSVG()">
                        <i class="bi bi-download"></i> SVG
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadPNG()">
                        <i class="bi bi-download"></i> PNG
                    </button>
                </div>
            </div>
            <div class="card-body bg-light p-2" style="height: calc(100vh - 250px); overflow: auto; position: relative;">
                <div id="diagram-preview" class="text-center">
                    <div class="text-muted py-5">
                        <i class="bi bi-diagram-3 display-1"></i>
                        <p class="mt-3">Enter flow configuration to see preview</p>
                    </div>
                </div>
                <div id="error-message" class="alert alert-danger mt-3 d-none" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-text"></span>
                </div>

                <!-- Node Popup (Color Picker + Associations for Published Diagrams) -->
                <div id="color-picker-popup" style="display: none; position: absolute; z-index: 1000; background: white; border: 2px solid var(--primary); border-radius: 8px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 400px; min-width: 250px;">
                    <!-- Color Picker Section -->
                    <div style="margin-bottom: 8px;">
                        <label style="font-weight: 500; font-size: 13px; display: block; margin-bottom: 4px;" id="color-picker-label">Node Color</label>
                        <input type="color" id="color-picker-input" style="width: 100%; height: 40px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    </div>
                    <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                        <button id="color-picker-apply" class="btn btn-primary btn-sm" style="flex: 1;">Apply</button>
                        <button id="color-picker-cancel" class="btn btn-secondary btn-sm" style="flex: 1;">Cancel</button>
                    </div>

                    <!-- Associations Section (only for published diagrams) -->
                    <div id="node-associations-section" style="display: none; border-top: 1px solid #dee2e6; padding-top: 12px;">
                        <div style="font-weight: 500; font-size: 13px; margin-bottom: 8px;">
                            Article Associations
                        </div>

                        <!-- Supporting Sources -->
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: between; align-items: center; padding: 4px 0;">
                                <span style="font-size: 12px; color: #28a745;">
                                    <i class="bi bi-check-circle"></i> Supporting
                                </span>
                                <span id="supporting-score" class="badge bg-success" style="font-size: 11px;">0</span>
                            </div>
                            <div id="supporting-list" style="font-size: 11px; color: #666; max-height: 150px; overflow-y: auto;">
                                <em>No supporting sources</em>
                            </div>
                        </div>

                        <!-- Conflicting Sources -->
                        <div>
                            <div style="display: flex; justify-content: between; align-items: center; padding: 4px 0;">
                                <span style="font-size: 12px; color: #dc3545;">
                                    <i class="bi bi-x-circle"></i> Conflicting
                                </span>
                                <span id="conflicting-score" class="badge bg-danger" style="font-size: 11px;">0</span>
                            </div>
                            <div id="conflicting-list" style="font-size: 11px; color: #666; max-height: 150px; overflow-y: auto;">
                                <em>No conflicting sources</em>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tree Popup -->
                <div id="history-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; background: white; border: 2px solid var(--primary); border-radius: 8px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); max-height: 500px; overflow-y: auto; min-width: 400px;">
                    <div style="display: flex; justify-content: between align-items-center; margin-bottom: 12px;">
                        <h5 style="margin: 0;">Version History</h5>
                        <button id="history-close" class="btn btn-sm btn-secondary" style="margin-left: auto;">✕</button>
                    </div>
                    <div id="history-tree-view" style="font-family: monospace; font-size: 12px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attribution -->
<div class="alert alert-info mt-3">
    <strong>Powered by SankeyMatic:</strong> Copyright © 2014-2024 Steve Bogart
    &lt;sbogart@sankeymatic.com&gt;.
    Licensed under the ISC License.
    <a href="https://github.com/nowthis/sankeymatic" target="_blank" class="alert-link">
        View on GitHub <i class="bi bi-box-arrow-up-right"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load D3.js and D3-sankey plugin -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12/dist/d3-sankey.min.js"></script>

<script>
// Template configurations
const templates = {
    simple: `A [100] B
B [60] C
B [40] D`,

    article: `RSS Feeds [500] New Articles
New Articles [300] Manual Review
New Articles [200] Auto-Rejected
Manual Review [250] Approved
Manual Review [50] Rejected
Approved [200] Published
Approved [50] Archived

:RSS Feeds #4A90E2
:New Articles #F5A623
:Manual Review #7ED321
:Approved #50E3C2
:Published #B8E986
:Auto-Rejected #D0021B
:Rejected #D0021B
:Archived #9013FE`,

    budget: `Income [5000] Budget
Budget [2000] Housing
Budget [1500] Food
Budget [800] Transport
Budget [500] Entertainment
Budget [200] Savings

:Income #2ECC71
:Budget #3498DB
:Savings #F39C12`
};

// Diagram metadata
const diagramId = {{ diagram.pk|default:"null" }};
const isPublished = {{ diagram.is_published|yesno:"true,false" }};

let renderTimeout = null;
let currentColorNode = null;
let currentColorLink = null;
let savedNodePositions = {}; // Store custom node positions
let savedLinkColors = {}; // Store custom link colors
let savedCanvasSize = { width: 1200, height: 600 }; // Track canvas size for scaling

// Autosave and version history
let historyTree = {
    id: 0,
    parent: null,
    children: [],
    timestamp: Date.now(),
    config: '',
    positions: {},
    linkColors: {},
    settings: {}
};
let currentHistoryNode = historyTree;
let historyCounter = 0;
let autosaveInterval = null;

// Load a template
function loadTemplate(templateName) {
    if (templates[templateName]) {
        document.getElementById('diagram-config').value = templates[templateName];
        renderDiagram();
    }
}

// Color picker functions
function showColorPicker(node, event) {
    currentColorNode = node;
    currentColorLink = null;
    const popup = document.getElementById('color-picker-popup');
    const input = document.getElementById('color-picker-input');
    const label = document.getElementById('color-picker-label');

    label.textContent = 'Node Color';

    // Set current color (use default if no color set)
    const currentColor = node.color || '#4682b4';
    input.value = currentColor;

    // Position near click - use pageX/pageY for more reliable positioning
    const container = document.querySelector('.card-body.bg-light');
    const containerRect = container.getBoundingClientRect();

    // Position to the right of the click point
    let left = event.pageX - containerRect.left - window.pageXOffset + 20;
    let top = event.pageY - containerRect.top - window.pageYOffset;

    // Keep within bounds (increased width for associations section)
    if (left + 300 > container.clientWidth) {
        left = event.pageX - containerRect.left - window.pageXOffset - 320; // Show on left instead
    }
    if (top + 400 > container.clientHeight) {
        top = container.clientHeight - 400;
    }

    popup.style.left = Math.max(10, left) + 'px';
    popup.style.top = Math.max(10, top) + 'px';
    popup.style.display = 'block';

    // Load associations if diagram is published
    if (isPublished && diagramId) {
        loadNodeAssociations(node.name);
    } else {
        document.getElementById('node-associations-section').style.display = 'none';
    }

    console.log('Color picker shown for node:', node.name, 'at position:', left, top);
}

function hideColorPicker() {
    document.getElementById('color-picker-popup').style.display = 'none';
    currentColorNode = null;
}

function showLinkColorPicker(link, event) {
    currentColorLink = link;
    currentColorNode = null;
    const popup = document.getElementById('color-picker-popup');
    const input = document.getElementById('color-picker-input');
    const label = document.getElementById('color-picker-label');

    label.textContent = 'Link Color';

    // Get link key
    const linkKey = `${link.source.name}->${link.target.name}`;
    const currentColor = savedLinkColors[linkKey] || link.source.color || '#999';
    input.value = currentColor;

    // Position near click
    const container = document.querySelector('.card-body.bg-light');
    const containerRect = container.getBoundingClientRect();

    let left = event.pageX - containerRect.left - window.pageXOffset + 20;
    let top = event.pageY - containerRect.top - window.pageYOffset;

    if (left + 200 > container.clientWidth) {
        left = event.pageX - containerRect.left - window.pageXOffset - 220;
    }
    if (top + 120 > container.clientHeight) {
        top = container.clientHeight - 120;
    }

    popup.style.left = Math.max(10, left) + 'px';
    popup.style.top = Math.max(10, top) + 'px';
    popup.style.display = 'block';

    console.log('Link color picker shown for:', linkKey);
}

function applyColor() {
    const newColor = document.getElementById('color-picker-input').value;

    if (currentColorNode) {
        currentColorNode.color = newColor;

        // Update the visual
        d3.selectAll('.node')
            .filter(d => d === currentColorNode)
            .select('rect')
            .attr('fill', newColor);

        // Update links that originate from this node
        d3.selectAll('.sankey-link')
            .filter(d => d.source === currentColorNode)
            .attr('stroke', newColor);

        // Update the config text to include the color
        updateConfigWithColors();
    } else if (currentColorLink) {
        const linkKey = `${currentColorLink.source.name}->${currentColorLink.target.name}`;
        savedLinkColors[linkKey] = newColor;

        // Update the visual
        d3.selectAll('.sankey-link')
            .filter(d => d === currentColorLink)
            .attr('stroke', newColor);
    }

    hideColorPicker();
    saveSnapshot(); // Auto-save after color change
}

function updateConfigWithColors() {
    const config = document.getElementById('diagram-config').value;
    const lines = config.split('\n');
    const newLines = [];
    const coloredNodes = new Set();

    // First pass: keep non-color lines and track which nodes already have colors
    for (let line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith(':')) {
            const match = trimmed.match(/^:(.+?)\s+#/);
            if (match) {
                coloredNodes.add(match[1].trim());
            }
        } else {
            newLines.push(line);
        }
    }

    // Add color definitions at the end
    const allNodes = document.querySelectorAll('.node');
    const colorLines = [];
    allNodes.forEach(nodeEl => {
        const nodeData = d3.select(nodeEl).datum();
        if (nodeData && nodeData.color) {
            colorLines.push(`:${nodeData.name} ${nodeData.color}`);
        }
    });

    // Combine
    let finalConfig = newLines.join('\n');
    if (colorLines.length > 0) {
        finalConfig += '\n\n' + colorLines.join('\n');
    }

    document.getElementById('diagram-config').value = finalConfig.trim();
}

// Autosave and History Functions
function saveSnapshot() {
    const config = document.getElementById('diagram-config').value.trim();
    if (!config) return;

    const settings = {
        width: document.getElementById('diagram-width').value,
        height: document.getElementById('diagram-height').value,
        nodeWidth: document.getElementById('node-width').value,
        nodePadding: document.getElementById('node-padding').value,
        showNodes: document.getElementById('show-nodes').checked,
        showLabels: document.getElementById('show-labels').checked,
        labelPosition: document.querySelector('input[name="label-position"]:checked').value
    };

    // Create new history node
    historyCounter++;
    const newNode = {
        id: historyCounter,
        parent: currentHistoryNode,
        children: [],
        timestamp: Date.now(),
        config: config,
        positions: JSON.parse(JSON.stringify(savedNodePositions)),
        linkColors: JSON.parse(JSON.stringify(savedLinkColors)),
        settings: settings
    };

    currentHistoryNode.children.push(newNode);
    currentHistoryNode = newNode;

    console.log('Snapshot saved:', newNode.id, 'at', new Date(newNode.timestamp).toLocaleTimeString());
}

function loadSnapshot(node) {
    document.getElementById('diagram-config').value = node.config;
    savedNodePositions = JSON.parse(JSON.stringify(node.positions));
    savedLinkColors = JSON.parse(JSON.stringify(node.linkColors));

    // Restore settings
    if (node.settings.width) {
        document.getElementById('diagram-width').value = node.settings.width;
        document.getElementById('width-value').textContent = node.settings.width;
    }
    if (node.settings.height) {
        document.getElementById('diagram-height').value = node.settings.height;
        document.getElementById('height-value').textContent = node.settings.height;
    }
    if (node.settings.nodeWidth) {
        document.getElementById('node-width').value = node.settings.nodeWidth;
        document.getElementById('node-width-value').textContent = node.settings.nodeWidth;
    }
    if (node.settings.nodePadding) {
        document.getElementById('node-padding').value = node.settings.nodePadding;
        document.getElementById('node-padding-value').textContent = node.settings.nodePadding;
    }
    if (typeof node.settings.showNodes !== 'undefined') {
        document.getElementById('show-nodes').checked = node.settings.showNodes;
    }
    if (typeof node.settings.showLabels !== 'undefined') {
        document.getElementById('show-labels').checked = node.settings.showLabels;
    }
    if (node.settings.labelPosition) {
        document.getElementById('label-' + node.settings.labelPosition).checked = true;
    }

    currentHistoryNode = node;
    renderDiagram();
    hideHistoryTree();
}

function toggleAutosave() {
    const enabled = document.getElementById('autosave-enabled').checked;

    if (enabled) {
        // Autosave every 30 seconds
        autosaveInterval = setInterval(() => {
            saveSnapshot();
        }, 30000);
        console.log('Autosave enabled (every 30s)');
    } else {
        if (autosaveInterval) {
            clearInterval(autosaveInterval);
            autosaveInterval = null;
        }
        console.log('Autosave disabled');
    }
}

function showHistoryTree() {
    const popup = document.getElementById('history-popup');
    const treeView = document.getElementById('history-tree-view');

    // Build tree visualization
    let html = '<div style="padding: 8px;">';
    html += renderHistoryNode(historyTree, 0);
    html += '</div>';

    treeView.innerHTML = html;
    popup.style.display = 'block';
}

function hideHistoryTree() {
    document.getElementById('history-popup').style.display = 'none';
}

function renderHistoryNode(node, depth) {
    const indent = '  '.repeat(depth);
    const isCurrent = node === currentHistoryNode;
    const time = new Date(node.timestamp).toLocaleTimeString();
    const style = isCurrent ? 'background: #e6f2f7; padding: 4px; border-radius: 3px; font-weight: bold;' : 'padding: 4px;';

    let html = `<div style="${style}">${indent}`;
    html += isCurrent ? '▶ ' : '○ ';
    html += `<span style="color: #666;">#${node.id}</span> `;
    html += `<span style="color: #003d59;">${time}</span> `;
    html += `<button onclick="loadSnapshot(findNode(${node.id}))" class="btn btn-xs btn-primary" style="font-size: 10px; padding: 2px 6px;">Load</button>`;
    html += '</div>';

    for (let child of node.children) {
        html += renderHistoryNode(child, depth + 1);
    }

    return html;
}

function findNode(id) {
    function search(node) {
        if (node.id === id) return node;
        for (let child of node.children) {
            const found = search(child);
            if (found) return found;
        }
        return null;
    }
    return search(historyTree);
}

// Clear configuration
function clearConfig() {
    if (confirm('Clear all configuration?')) {
        document.getElementById('diagram-config').value = '';
        savedNodePositions = {}; // Clear saved positions
        savedLinkColors = {}; // Clear link colors
        document.getElementById('diagram-preview').innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-diagram-3 display-1"></i>
                <p class="mt-3">Enter flow configuration to see preview</p>
            </div>
        `;
        document.getElementById('error-message').classList.add('d-none');
        saveSnapshot(); // Save the cleared state
    }
}

// Parse SankeyMatic config format
function parseConfig(config) {
    const lines = config.split('\n');
    const nodes = new Map();
    const links = [];
    const colors = new Map();

    for (let line of lines) {
        line = line.trim();

        // Skip comments and empty lines
        if (!line || line.startsWith('//')) continue;

        // Parse color definitions: :NodeName #HexColor
        if (line.startsWith(':')) {
            const colorMatch = line.match(/:(.+?)\s+#([0-9A-Fa-f]{6})/);
            if (colorMatch) {
                colors.set(colorMatch[1].trim(), '#' + colorMatch[2]);
            }
            continue;
        }

        // Parse flow: Source [amount] Target
        const flowMatch = line.match(/^(.+?)\s*\[([0-9.]+|\*)\]\s*(.+)$/);
        if (flowMatch) {
            const source = flowMatch[1].trim();
            const value = parseFloat(flowMatch[2]) || 0;
            const target = flowMatch[3].trim();

            if (value > 0) {
                nodes.set(source, source);
                nodes.set(target, target);
                links.push({ source, target, value });
            }
        }
    }

    return {
        nodes: Array.from(nodes.keys()).map(name => ({
            name,
            color: colors.get(name) || null
        })),
        links
    };
}

// Render diagram using D3-sankey
function renderDiagram() {
    const config = document.getElementById('diagram-config').value.trim();
    const preview = document.getElementById('diagram-preview');
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    if (!config) {
        preview.innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-diagram-3 display-1"></i>
                <p class="mt-3">Enter flow configuration to see preview</p>
            </div>
        `;
        errorDiv.classList.add('d-none');
        return;
    }

    try {
        errorDiv.classList.add('d-none');

        // Parse the configuration
        const data = parseConfig(config);

        if (data.links.length === 0) {
            throw new Error('No valid flow definitions found. Use format: Source [amount] Target');
        }

        // Get settings
        const showNodes = document.getElementById('show-nodes').checked;
        const showLabels = document.getElementById('show-labels').checked;
        const labelPosition = document.querySelector('input[name="label-position"]:checked').value;
        const nodeWidth = parseInt(document.getElementById('node-width').value) || 15;
        const nodePadding = parseInt(document.getElementById('node-padding').value) || 10;

        // Clear preview and create SVG
        preview.innerHTML = '';

        let width = parseInt(document.getElementById('diagram-width').value) || 1200;
        let height = parseInt(document.getElementById('diagram-height').value) || 600;

        const svg = d3.select('#diagram-preview')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height])
            .attr('style', 'max-width: 100%; height: auto; background: white;');

        // Create sankey generator
        // If nodes are hidden, use nodeWidth of 0 to close gaps
        const sankey = d3.sankey()
            .nodeWidth(showNodes ? nodeWidth : 0)
            .nodePadding(nodePadding)
            .extent([[1, 5], [width - 1, height - 5]])
            .nodeSort((a, b) => {
                // Maintain order as they appear in the config
                // This ensures child nodes stack in entry order
                return 0; // Don't reorder - keep original parse order
            })
            .linkSort((a, b) => {
                // Keep links in order they appear in config
                // This ensures stacking matches config order
                return 0;
            });

        // Prepare nodes and links for d3-sankey
        // d3-sankey expects links to reference nodes by index or object
        const nodeMap = new Map();
        const nodes = data.nodes.map((d, i) => {
            const node = Object.assign({}, d);
            node.index = i; // Store original index for ordering
            nodeMap.set(d.name, i);
            return node;
        });

        const links = data.links.map(d => ({
            source: nodeMap.get(d.source),
            target: nodeMap.get(d.target),
            value: d.value
        }));

        // Generate the sankey diagram layout
        const graph = sankey({nodes, links});

        // Restore saved positions if they exist, scaled to current canvas size
        const scaleX = width / savedCanvasSize.width;
        const scaleY = height / savedCanvasSize.height;

        graph.nodes.forEach(d => {
            if (savedNodePositions[d.name]) {
                const saved = savedNodePositions[d.name];
                const nodeWidth = d.x1 - d.x0;
                const nodeHeight = d.y1 - d.y0;

                // Scale the saved position to current canvas size
                const scaledX = saved.x * scaleX;
                const scaledY = saved.y * scaleY;

                // Constrain to bounds
                d.x0 = Math.max(1, Math.min(width - nodeWidth - 1, scaledX));
                d.y0 = Math.max(1, Math.min(height - nodeHeight - 1, scaledY));
                d.x1 = d.x0 + nodeWidth;
                d.y1 = d.y0 + nodeHeight;
            }
        });

        // Update saved canvas size for future scaling
        savedCanvasSize.width = width;
        savedCanvasSize.height = height;

        // Color scale
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        // Store original positions for dragging
        graph.nodes.forEach(d => {
            d.origX = d.x0;  // Current position (updates during drag)
            d.origY = d.y0;
            d.lastX = d.x0;  // Last position (for shift key)
            d.lastY = d.y0;
            d.trueOrigX = d.x0;  // True original (never changes, for reset)
            d.trueOrigY = d.y0;
        });

        // Add helper layer (for drag guides)
        const helperLayer = svg.append('g')
            .attr('id', 'helper-layer')
            .style('pointer-events', 'none');

        // Add links group
        const linksGroup = svg.append('g')
            .attr('id', 'links-group')
            .attr('fill', 'none');

        const links_paths = linksGroup
            .selectAll('path')
            .data(graph.links)
            .join('path')
            .attr('class', 'sankey-link')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', d => {
                // Check for saved link color first
                const linkKey = `${d.source.name}->${d.target.name}`;
                if (savedLinkColors[linkKey]) {
                    return savedLinkColors[linkKey];
                }
                // Otherwise use node color
                const sourceNode = graph.nodes[d.source];
                const sourceColor = sourceNode ? sourceNode.color : null;
                return sourceColor || color(d.source);
            })
            .attr('stroke-width', d => Math.max(1, d.width))
            .attr('opacity', 0.5)
            .attr('cursor', 'pointer')
            .on('click', function(event, d) {
                event.stopPropagation();
                showLinkColorPicker(d, event);
            })
            .on('mouseenter', function() {
                d3.select(this).attr('opacity', 0.8);
            })
            .on('mouseleave', function() {
                d3.select(this).attr('opacity', 0.5);
            })
            .append('title')
            .text(d => {
                const sourceName = d.source.name;
                const targetName = d.target.name;
                return `${sourceName} → ${targetName}\n${d.value}\n\nClick to change color`;
            });

        // Track if we're actually dragging (to distinguish from clicks)
        let isDragging = false;
        let dragStartPos = { x: 0, y: 0 };

        // Drag handlers
        function dragStarted(event, d) {
            isDragging = false;
            dragStartPos = { x: event.x, y: event.y };
            helperLayer.selectAll('*').remove();

            // Draw guide lines
            helperLayer.append('line')
                .attr('x1', 0).attr('x2', width)
                .attr('y1', d.y0).attr('y2', d.y0)
                .attr('stroke', '#999')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.5);

            helperLayer.append('line')
                .attr('x1', d.x0).attr('x2', d.x0)
                .attr('y1', 0).attr('y2', height)
                .attr('stroke', '#999')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.5);

            // Ghost rectangle at original position
            helperLayer.append('rect')
                .attr('x', d.origX)
                .attr('y', d.origY)
                .attr('width', d.x1 - d.x0)
                .attr('height', d.y1 - d.y0)
                .attr('fill', d.color || color(d.name))
                .attr('opacity', 0.2)
                .attr('stroke', '#666')
                .attr('stroke-dasharray', '2,2');

            // Show shift hint if not pressed
            if (!event.sourceEvent?.shiftKey) {
                helperLayer.append('text')
                    .attr('x', width / 2)
                    .attr('y', 20)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#666')
                    .attr('font-size', '14px')
                    .text('Hold Shift to move in only one direction');
            }
        }

        function dragged(event, d) {
            // Check if we've moved enough to be considered dragging
            const dx = Math.abs(event.x - dragStartPos.x);
            const dy = Math.abs(event.y - dragStartPos.y);
            if (dx > 3 || dy > 3) {
                isDragging = true;
            }

            let newX = event.x;
            let newY = event.y;

            // Shift key detection for constrained dragging
            if (event.sourceEvent?.shiftKey) {
                // Remove shift hint
                helperLayer.selectAll('text').remove();

                // Determine dominant direction from start of drag
                const deltaX = Math.abs(newX - d.origX);
                const deltaY = Math.abs(newY - d.origY);

                if (deltaX > deltaY) {
                    newY = d.origY; // Constrain to horizontal
                } else {
                    newX = d.origX; // Constrain to vertical
                }
            }

            // Constrain to graph bounds
            const nodeWidth = d.x1 - d.x0;
            const nodeHeight = d.y1 - d.y0;
            newX = Math.max(1, Math.min(width - nodeWidth - 1, newX));
            newY = Math.max(1, Math.min(height - nodeHeight - 1, newY));

            // Update node data position
            d.x0 = newX;
            d.x1 = newX + nodeWidth;
            d.y0 = newY;
            d.y1 = newY + nodeHeight;

            // Update rect position directly (no transforms)
            d3.select(this).select('rect')
                .attr('x', d.x0)
                .attr('y', d.y0);

            // Recalculate and redraw links
            sankey.update(graph);
            linksGroup.selectAll('path')
                .attr('d', d3.sankeyLinkHorizontal());

            // Update label position (if labels are shown)
            if (showLabels) {
                labelsGroup.selectAll('text')
                    .filter(n => n === d)
                    .attr('x', () => {
                        if (labelPosition === 'left') return d.x0 - 6;
                        if (labelPosition === 'right') return d.x1 + 6;
                        return d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6;
                    })
                    .attr('y', (d.y1 + d.y0) / 2)
                    .attr('text-anchor', () => {
                        if (labelPosition === 'left') return 'end';
                        if (labelPosition === 'right') return 'start';
                        return d.x0 < width / 2 ? 'start' : 'end';
                    });
            }
        }

        function dragEnded(event, d) {
            // Clean up helpers
            helperLayer.selectAll('*').remove();

            // Update original position to current position (makes this the new "home")
            d.origX = d.x0;
            d.origY = d.y0;
            d.lastX = d.x0;
            d.lastY = d.y0;

            // Save position for future renders
            savedNodePositions[d.name] = {
                x: d.x0,
                y: d.y0
            };

            // Final relayout
            sankey.update(graph);
            linksGroup.selectAll('path')
                .attr('d', d3.sankeyLinkHorizontal());

            // Update all labels (if labels are shown)
            if (showLabels) {
                labelsGroup.selectAll('text')
                    .attr('x', n => {
                        if (labelPosition === 'left') return n.x0 - 6;
                        if (labelPosition === 'right') return n.x1 + 6;
                        return n.x0 < width / 2 ? n.x1 + 6 : n.x0 - 6;
                    })
                    .attr('y', n => (n.y1 + n.y0) / 2)
                    .attr('text-anchor', n => {
                        if (labelPosition === 'left') return 'end';
                        if (labelPosition === 'right') return 'start';
                        return n.x0 < width / 2 ? 'start' : 'end';
                    });
            }
        }

        // Double-click to reset to original position
        function doubleClicked(event, d) {
            const nodeWidth = d.x1 - d.x0;
            const nodeHeight = d.y1 - d.y0;

            // Reset to true original position
            d.x0 = d.trueOrigX;
            d.y0 = d.trueOrigY;
            d.x1 = d.trueOrigX + nodeWidth;
            d.y1 = d.trueOrigY + nodeHeight;
            d.origX = d.trueOrigX;
            d.origY = d.trueOrigY;
            d.lastX = d.trueOrigX;
            d.lastY = d.trueOrigY;

            // Clear saved position
            delete savedNodePositions[d.name];

            // Update rect position
            nodesGroup.selectAll('g')
                .filter(n => n === d)
                .select('rect')
                .attr('x', d.x0)
                .attr('y', d.y0);

            // Update layout and labels
            sankey.update(graph);
            linksGroup.selectAll('path').attr('d', d3.sankeyLinkHorizontal());

            if (showLabels) {
                labelsGroup.selectAll('text')
                    .attr('x', n => {
                        if (labelPosition === 'left') return n.x0 - 6;
                        if (labelPosition === 'right') return n.x1 + 6;
                        return n.x0 < width / 2 ? n.x1 + 6 : n.x0 - 6;
                    })
                    .attr('y', n => (n.y1 + n.y0) / 2)
                    .attr('text-anchor', n => {
                        if (labelPosition === 'left') return 'end';
                        if (labelPosition === 'right') return 'start';
                        return n.x0 < width / 2 ? 'start' : 'end';
                    });
            }
        }

        // Add draggable node groups
        const nodesGroup = svg.append('g')
            .attr('id', 'nodes-group');

        const nodeElements = nodesGroup
            .selectAll('g')
            .data(graph.nodes)
            .join('g')
            .attr('class', 'node')
            .attr('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded))
            .on('dblclick', doubleClicked)
            .on('click', function(event, d) {
                // Only trigger color picker on single click (not during drag)
                if (isDragging) {
                    isDragging = false; // Reset for next interaction
                    return;
                }
                event.stopPropagation();
                showColorPicker(d, event);
            })
            .on('mouseenter', function(event, d) {
                // Highlight on hover to show it's clickable
                if (!isDragging) {
                    d3.select(this).select('rect').attr('opacity', 1);
                }
            })
            .on('mouseleave', function(event, d) {
                d3.select(this).select('rect').attr('opacity', 0.8);
            });

        // Add node rectangles (if enabled)
        if (showNodes) {
            nodeElements.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', d => d.color || color(d.name))
                .attr('opacity', 0.8)
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .append('title')
                .text(d => `${d.name}\n${d.value}\n\nClick to change color\nDrag to move • Shift+drag for straight lines\nDouble-click to reset`);
        } else {
            // Add invisible hitbox for dragging when nodes are hidden
            nodeElements.append('rect')
                .attr('x', d => d.x0)
                .attr('y', d => d.y0)
                .attr('height', d => d.y1 - d.y0)
                .attr('width', d => d.x1 - d.x0)
                .attr('fill', 'transparent')
                .attr('stroke', 'transparent')
                .append('title')
                .text(d => `${d.name}\n${d.value}\n\nClick to change color\nDrag to move • Shift+drag for straight lines\nDouble-click to reset`);
        }

        // Add labels (if enabled)
        const labelsGroup = svg.append('g')
            .attr('id', 'labels-group')
            .style('font', '12px sans-serif')
            .style('pointer-events', 'none');

        if (showLabels) {
            const labelElements = labelsGroup
                .selectAll('text')
                .data(graph.nodes)
                .join('text')
                .attr('x', d => {
                    if (labelPosition === 'left') return d.x0 - 6;
                    if (labelPosition === 'right') return d.x1 + 6;
                    return d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6;
                })
                .attr('y', d => (d.y1 + d.y0) / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', d => {
                    if (labelPosition === 'left') return 'end';
                    if (labelPosition === 'right') return 'start';
                    return d.x0 < width / 2 ? 'start' : 'end';
                })
                .text(d => d.name)
                .append('tspan')
                .attr('fill-opacity', 0.7)
                .text(d => ` ${d.value}`);

            // Calculate label bounds and auto-resize if needed
            let minX = 0;
            let maxX = width;

            labelsGroup.selectAll('text').each(function(d) {
                const bbox = this.getBBox();
                minX = Math.min(minX, bbox.x);
                maxX = Math.max(maxX, bbox.x + bbox.width);
            });

            // Add padding if labels overflow
            const leftOverflow = Math.max(0, -minX);
            const rightOverflow = Math.max(0, maxX - width);

            if (leftOverflow > 0 || rightOverflow > 0) {
                const newWidth = width + leftOverflow + rightOverflow;
                const offsetX = leftOverflow;

                // Update SVG width and viewBox
                svg.attr('width', newWidth)
                   .attr('viewBox', [0, 0, newWidth, height]);

                // Shift everything if there's left overflow
                if (offsetX > 0) {
                    svg.selectAll('g').attr('transform', `translate(${offsetX},0)`);
                }
            }
        }

    } catch (e) {
        errorText.textContent = e.message;
        errorDiv.classList.remove('d-none');
        preview.innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-exclamation-circle display-4 text-danger"></i>
                <p class="mt-3">Unable to render diagram</p>
            </div>
        `;
    }
}

// Auto-render on input (with debounce)
document.getElementById('diagram-config').addEventListener('input', function() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(renderDiagram, 1000);
});

// Color picker button handlers
document.getElementById('color-picker-apply').addEventListener('click', applyColor);
document.getElementById('color-picker-cancel').addEventListener('click', hideColorPicker);

// History popup handlers
document.getElementById('history-close').addEventListener('click', hideHistoryTree);

// Hide color picker when clicking outside
document.addEventListener('click', function(event) {
    const popup = document.getElementById('color-picker-popup');
    const picker = document.getElementById('color-picker-input');

    if (popup.style.display === 'block' &&
        !popup.contains(event.target) &&
        !event.target.closest('.node') &&
        !event.target.closest('.sankey-link')) {
        hideColorPicker();
    }
});

// Initialize autosave
toggleAutosave();

// Save form handler
document.getElementById('save-diagram-form').addEventListener('submit', function(e) {
    const config = document.getElementById('diagram-config').value.trim();

    if (!config) {
        e.preventDefault();
        alert('Please enter a diagram configuration before saving.');
        return false;
    }

    // Copy config to hidden input
    document.getElementById('config-text-input').value = config;

    // Get settings
    const settings = {
        width: document.getElementById('diagram-width').value,
        height: document.getElementById('diagram-height').value,
        nodeWidth: document.getElementById('node-width').value,
        nodePadding: document.getElementById('node-padding').value,
        showNodes: document.getElementById('show-nodes').checked,
        showLabels: document.getElementById('show-labels').checked,
        labelPosition: document.querySelector('input[name="label-position"]:checked').value
    };
    document.getElementById('settings-json-input').value = JSON.stringify(settings);
});

// Download SVG
function downloadSVG() {
    const svg = document.querySelector('#diagram-preview svg');
    if (!svg) {
        alert('Please render a diagram first');
        return;
    }

    const svgData = new XMLSerializer().serializeToString(svg);
    const blob = new Blob([svgData], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = (document.getElementById('diagram-name').value || 'sankey-diagram') + '.svg';
    link.click();
    URL.revokeObjectURL(url);
}

// Download PNG
function downloadPNG() {
    const svg = document.querySelector('#diagram-preview svg');
    if (!svg) {
        alert('Please render a diagram first');
        return;
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const svgData = new XMLSerializer().serializeToString(svg);
    const img = new Image();

    const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);

    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        canvas.toBlob(function(blob) {
            const pngUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = pngUrl;
            link.download = (document.getElementById('diagram-name').value || 'sankey-diagram') + '.png';
            link.click();
            URL.revokeObjectURL(pngUrl);
            URL.revokeObjectURL(url);
        });
    };

    img.src = url;
}

// Publishing and Association Functions
function publishDiagram() {
    if (!diagramId) {
        alert('Please save the diagram first before publishing.');
        return;
    }

    if (!confirm('Publishing will lock the diagram structure and create database entries for all nodes. You can still change colors and positions. Continue?')) {
        return;
    }

    // Get all current nodes from the diagram
    const config = document.getElementById('diagram-config').value;
    const { nodeMap } = parseDiagramConfig(config);

    const nodes = Array.from(nodeMap.values()).map(node => ({
        name: node.name,
        color: node.color
    }));

    const publishBtn = document.getElementById('publish-btn');
    if (publishBtn) {
        publishBtn.disabled = true;
        publishBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Publishing...';
    }

    fetch(`/sankey/ajax/publish/${diagramId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ nodes: nodes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.reload(); // Reload to show published status
        } else {
            alert('Error: ' + data.message);
            if (publishBtn) {
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="bi bi-globe"></i> Publish Diagram';
            }
        }
    })
    .catch(error => {
        console.error('Error publishing diagram:', error);
        alert('Error publishing diagram: ' + error.message);
        if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.innerHTML = '<i class="bi bi-globe"></i> Publish Diagram';
        }
    });
}

function loadNodeAssociations(nodeName) {
    const associationsSection = document.getElementById('node-associations-section');
    const supportingList = document.getElementById('supporting-list');
    const conflictingList = document.getElementById('conflicting-list');
    const supportingScore = document.getElementById('supporting-score');
    const conflictingScore = document.getElementById('conflicting-score');

    // Show loading state
    supportingList.innerHTML = '<em>Loading...</em>';
    conflictingList.innerHTML = '<em>Loading...</em>';
    associationsSection.style.display = 'block';

    fetch(`/sankey/ajax/nodes/${diagramId}/${encodeURIComponent(nodeName)}/associations/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update scores
                supportingScore.textContent = data.supporting_score || 0;
                conflictingScore.textContent = data.conflicting_score || 0;

                // Update supporting list
                if (data.supporting.length > 0) {
                    supportingList.innerHTML = data.supporting.map(assoc => `
                        <div style="padding: 4px 0; border-bottom: 1px solid #eee;">
                            <a href="/article/${assoc.article_id}/" target="_blank" style="text-decoration: none; color: #28a745;">
                                ${assoc.article_title.substring(0, 60)}${assoc.article_title.length > 60 ? '...' : ''}
                            </a>
                            <span class="badge bg-success" style="font-size: 10px;">+${assoc.score}</span>
                        </div>
                    `).join('');
                } else {
                    supportingList.innerHTML = '<em>No supporting sources</em>';
                }

                // Update conflicting list
                if (data.conflicting.length > 0) {
                    conflictingList.innerHTML = data.conflicting.map(assoc => `
                        <div style="padding: 4px 0; border-bottom: 1px solid #eee;">
                            <a href="/article/${assoc.article_id}/" target="_blank" style="text-decoration: none; color: #dc3545;">
                                ${assoc.article_title.substring(0, 60)}${assoc.article_title.length > 60 ? '...' : ''}
                            </a>
                            <span class="badge bg-danger" style="font-size: 10px;">+${assoc.score}</span>
                        </div>
                    `).join('');
                } else {
                    conflictingList.innerHTML = '<em>No conflicting sources</em>';
                }
            } else {
                supportingList.innerHTML = '<em>Error loading associations</em>';
                conflictingList.innerHTML = '<em>Error loading associations</em>';
            }
        })
        .catch(error => {
            console.error('Error loading associations:', error);
            supportingList.innerHTML = '<em>Error loading</em>';
            conflictingList.innerHTML = '<em>Error loading</em>';
        });
}

// Initial render if editing
{% if diagram %}
document.addEventListener('DOMContentLoaded', function() {
    // Restore settings if available
    {% if diagram.settings_json %}
    try {
        const settings = {{ diagram.settings_json|safe }};
        if (settings.width) {
            document.getElementById('diagram-width').value = settings.width;
            document.getElementById('width-value').textContent = settings.width;
        }
        if (settings.height) {
            document.getElementById('diagram-height').value = settings.height;
            document.getElementById('height-value').textContent = settings.height;
        }
        // Handle both new (nodeWidth) and old (nodeHeight) parameter names
        const nodeWidthValue = settings.nodeWidth || settings.nodeHeight || 15;
        document.getElementById('node-width').value = nodeWidthValue;
        document.getElementById('node-width-value').textContent = nodeWidthValue;

        if (settings.nodePadding) {
            document.getElementById('node-padding').value = settings.nodePadding;
            document.getElementById('node-padding-value').textContent = settings.nodePadding;
        }
        if (typeof settings.showNodes !== 'undefined') {
            document.getElementById('show-nodes').checked = settings.showNodes;
        }
        if (typeof settings.showLabels !== 'undefined') {
            document.getElementById('show-labels').checked = settings.showLabels;
        }
        if (settings.labelPosition) {
            document.getElementById('label-' + settings.labelPosition).checked = true;
        }
    } catch (e) {
        console.error('Error loading settings:', e);
    }
    {% endif %}
    renderDiagram();
});
{% endif %}
</script>
{% endblock %}
