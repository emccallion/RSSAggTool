{% extends 'articles/base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Edit{% else %}Build{% endif %} Sankey Diagram{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-diagram-3"></i> {% if is_edit %}Edit{% else %}Build{% endif %} Sankey Diagram</h2>
            <a href="{% url 'sankey_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
</div>

<!-- Save Form -->
<div class="card mb-3 border-success">
    <div class="card-header bg-success text-white">
        <i class="bi bi-save"></i> Save Diagram
    </div>
    <div class="card-body">
        <form method="post" id="save-diagram-form">
            {% csrf_token %}
            <div class="row g-3">
                <div class="col-md-5">
                    <label for="diagram-name" class="form-label">Diagram Name *</label>
                    <input type="text" class="form-control" id="diagram-name" name="name"
                           value="{{ diagram.name|default:'' }}" required
                           placeholder="Enter diagram name">
                </div>
                <div class="col-md-5">
                    <label for="diagram-description" class="form-label">Description</label>
                    <input type="text" class="form-control" id="diagram-description" name="description"
                           value="{{ diagram.description|default:'' }}"
                           placeholder="Optional description">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-save"></i> Save
                    </button>
                </div>
            </div>
            <input type="hidden" id="config-text-input" name="config_text" value="">
            <input type="hidden" id="settings-json-input" name="settings_json" value="{}">
        </form>
    </div>
</div>

<!-- Diagram Builder -->
<div class="row g-0">
    <!-- Left Column: Editor (20%) -->
    <div class="col-12 col-xl-2" style="border-right: 2px solid #dee2e6; height: calc(100vh - 200px); overflow-y: auto;">
        <div class="p-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted"><i class="bi bi-pencil-square"></i> Configuration</small>
                <button type="button" class="btn btn-xs btn-link p-0" data-bs-toggle="collapse" data-bs-target="#syntaxHelp">
                    <i class="bi bi-question-circle"></i>
                </button>
            </div>
            <div>
                <textarea id="diagram-config" class="form-control font-monospace" rows="30"
                          placeholder="Flow definitions...

Example:
A [100] B
B [60] C

:A #4A90E2"
                          style="resize: vertical; font-size: 11px;">{{ diagram.config_text|default:'' }}</textarea>

                <div class="mt-2">
                    <label class="form-label small">Quick Templates:</label>
                    <div class="d-grid gap-1">
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('simple')">
                            Simple
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('article')">
                            Article
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-secondary btn-sm" onclick="loadTemplate('budget')">
                            Budget
                        </button>
                        <button type="button" class="btn btn-xs btn-outline-danger btn-sm" onclick="clearConfig()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <div class="collapse mt-2" id="syntaxHelp">
                    <div class="alert alert-info p-2 small">
                        <strong>Syntax:</strong>
                        <ul class="mb-0" style="font-size: 10px; padding-left: 15px;">
                            <li><code>A [100] B</code></li>
                            <li><code>:A #FF6B6B</code></li>
                            <li><code>// Comment</code></li>
                        </ul>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="mt-3">
                    <small class="text-muted"><i class="bi bi-sliders"></i> Settings</small>
                </div>
                <div>
                    <div class="mb-2">
                        <label for="diagram-size" class="form-label small mb-1">Width</label>
                        <select id="diagram-size" class="form-select form-select-sm" onchange="renderDiagram()">
                            <option value="800">800px</option>
                            <option value="1000">1000px</option>
                            <option value="1200" selected>1200px</option>
                            <option value="1400">1400px</option>
                            <option value="1600">1600px</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="diagram-layout" class="form-label small mb-1">Layout</label>
                        <select id="diagram-layout" class="form-select form-select-sm" onchange="renderDiagram()">
                            <option value="horizontal" selected>Horizontal</option>
                            <option value="vertical">Vertical</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="renderDiagram()">
                        <i class="bi bi-arrow-clockwise"></i> Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Preview (80%) -->
    <div class="col-12 col-xl-10">
        <div class="card border-0 rounded-0" style="height: calc(100vh - 200px);">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-eye"></i> Live Preview</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadSVG()">
                        <i class="bi bi-download"></i> SVG
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadPNG()">
                        <i class="bi bi-download"></i> PNG
                    </button>
                </div>
            </div>
            <div class="card-body bg-light p-2" style="height: calc(100vh - 250px); overflow: auto;">
                <div id="diagram-preview" class="text-center">
                    <div class="text-muted py-5">
                        <i class="bi bi-diagram-3 display-1"></i>
                        <p class="mt-3">Enter flow configuration to see preview</p>
                    </div>
                </div>
                <div id="error-message" class="alert alert-danger mt-3 d-none" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-text"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attribution -->
<div class="alert alert-info mt-3">
    <strong>Powered by SankeyMatic:</strong> Copyright © 2014-2024 Steve Bogart
    &lt;sbogart@sankeymatic.com&gt;.
    Licensed under the ISC License.
    <a href="https://github.com/nowthis/sankeymatic" target="_blank" class="alert-link">
        View on GitHub <i class="bi bi-box-arrow-up-right"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load D3.js and D3-sankey plugin -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12/dist/d3-sankey.min.js"></script>

<script>
// Template configurations
const templates = {
    simple: `A [100] B
B [60] C
B [40] D`,

    article: `RSS Feeds [500] New Articles
New Articles [300] Manual Review
New Articles [200] Auto-Rejected
Manual Review [250] Approved
Manual Review [50] Rejected
Approved [200] Published
Approved [50] Archived

:RSS Feeds #4A90E2
:New Articles #F5A623
:Manual Review #7ED321
:Approved #50E3C2
:Published #B8E986
:Auto-Rejected #D0021B
:Rejected #D0021B
:Archived #9013FE`,

    budget: `Income [5000] Budget
Budget [2000] Housing
Budget [1500] Food
Budget [800] Transport
Budget [500] Entertainment
Budget [200] Savings

:Income #2ECC71
:Budget #3498DB
:Savings #F39C12`
};

let renderTimeout = null;

// Load a template
function loadTemplate(templateName) {
    if (templates[templateName]) {
        document.getElementById('diagram-config').value = templates[templateName];
        renderDiagram();
    }
}

// Clear configuration
function clearConfig() {
    if (confirm('Clear all configuration?')) {
        document.getElementById('diagram-config').value = '';
        document.getElementById('diagram-preview').innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-diagram-3 display-1"></i>
                <p class="mt-3">Enter flow configuration to see preview</p>
            </div>
        `;
        document.getElementById('error-message').classList.add('d-none');
    }
}

// Parse SankeyMatic config format
function parseConfig(config) {
    const lines = config.split('\n');
    const nodes = new Map();
    const links = [];
    const colors = new Map();

    for (let line of lines) {
        line = line.trim();

        // Skip comments and empty lines
        if (!line || line.startsWith('//')) continue;

        // Parse color definitions: :NodeName #HexColor
        if (line.startsWith(':')) {
            const colorMatch = line.match(/:(.+?)\s+#([0-9A-Fa-f]{6})/);
            if (colorMatch) {
                colors.set(colorMatch[1].trim(), '#' + colorMatch[2]);
            }
            continue;
        }

        // Parse flow: Source [amount] Target
        const flowMatch = line.match(/^(.+?)\s*\[([0-9.]+|\*)\]\s*(.+)$/);
        if (flowMatch) {
            const source = flowMatch[1].trim();
            const value = parseFloat(flowMatch[2]) || 0;
            const target = flowMatch[3].trim();

            if (value > 0) {
                nodes.set(source, source);
                nodes.set(target, target);
                links.push({ source, target, value });
            }
        }
    }

    return {
        nodes: Array.from(nodes.keys()).map(name => ({
            name,
            color: colors.get(name) || null
        })),
        links
    };
}

// Render diagram using D3-sankey
function renderDiagram() {
    const config = document.getElementById('diagram-config').value.trim();
    const preview = document.getElementById('diagram-preview');
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');

    if (!config) {
        preview.innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-diagram-3 display-1"></i>
                <p class="mt-3">Enter flow configuration to see preview</p>
            </div>
        `;
        errorDiv.classList.add('d-none');
        return;
    }

    try {
        errorDiv.classList.add('d-none');

        // Parse the configuration
        const data = parseConfig(config);

        if (data.links.length === 0) {
            throw new Error('No valid flow definitions found. Use format: Source [amount] Target');
        }

        // Clear preview and create SVG
        preview.innerHTML = '';

        const width = parseInt(document.getElementById('diagram-size').value) || 800;
        const height = Math.max(400, data.nodes.length * 40);

        const svg = d3.select('#diagram-preview')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', [0, 0, width, height])
            .attr('style', 'max-width: 100%; height: auto; background: white;');

        // Create sankey generator
        const sankey = d3.sankey()
            .nodeWidth(15)
            .nodePadding(10)
            .extent([[1, 5], [width - 1, height - 5]]);

        // Prepare nodes and links for d3-sankey
        // d3-sankey expects links to reference nodes by index or object
        const nodeMap = new Map();
        const nodes = data.nodes.map((d, i) => {
            const node = Object.assign({}, d);
            nodeMap.set(d.name, i);
            return node;
        });

        const links = data.links.map(d => ({
            source: nodeMap.get(d.source),
            target: nodeMap.get(d.target),
            value: d.value
        }));

        // Generate the sankey diagram layout
        const graph = sankey({nodes, links});

        // Color scale
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        // Store original positions for dragging
        graph.nodes.forEach(d => {
            d.origX = d.x0;  // Current position (updates during drag)
            d.origY = d.y0;
            d.lastX = d.x0;  // Last position (for shift key)
            d.lastY = d.y0;
            d.trueOrigX = d.x0;  // True original (never changes, for reset)
            d.trueOrigY = d.y0;
        });

        // Add helper layer (for drag guides)
        const helperLayer = svg.append('g')
            .attr('id', 'helper-layer')
            .style('pointer-events', 'none');

        // Add links group
        const linksGroup = svg.append('g')
            .attr('id', 'links-group')
            .attr('fill', 'none');

        const links_paths = linksGroup
            .selectAll('path')
            .data(graph.links)
            .join('path')
            .attr('class', 'sankey-link')
            .attr('d', d3.sankeyLinkHorizontal())
            .attr('stroke', d => {
                const sourceNode = graph.nodes[d.source];
                const sourceColor = sourceNode ? sourceNode.color : null;
                return sourceColor || color(d.source);
            })
            .attr('stroke-width', d => Math.max(1, d.width))
            .attr('opacity', 0.5)
            .append('title')
            .text(d => {
                const sourceName = graph.nodes[d.source]?.name || d.source;
                const targetName = graph.nodes[d.target]?.name || d.target;
                return `${sourceName} → ${targetName}\n${d.value}`;
            });

        // Drag handlers
        function dragStarted(event, d) {
            helperLayer.selectAll('*').remove();

            // Draw guide lines
            helperLayer.append('line')
                .attr('x1', 0).attr('x2', width)
                .attr('y1', d.y0).attr('y2', d.y0)
                .attr('stroke', '#999')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.5);

            helperLayer.append('line')
                .attr('x1', d.x0).attr('x2', d.x0)
                .attr('y1', 0).attr('y2', height)
                .attr('stroke', '#999')
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '3,3')
                .attr('opacity', 0.5);

            // Ghost rectangle at original position
            helperLayer.append('rect')
                .attr('x', d.origX)
                .attr('y', d.origY)
                .attr('width', d.x1 - d.x0)
                .attr('height', d.y1 - d.y0)
                .attr('fill', d.color || color(d.name))
                .attr('opacity', 0.2)
                .attr('stroke', '#666')
                .attr('stroke-dasharray', '2,2');

            // Show shift hint if not pressed
            if (!event.sourceEvent?.shiftKey) {
                helperLayer.append('text')
                    .attr('x', width / 2)
                    .attr('y', 20)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#666')
                    .attr('font-size', '14px')
                    .text('Hold Shift to move in only one direction');
            }
        }

        function dragged(event, d) {
            let newX = event.x;
            let newY = event.y;

            // Shift key detection for constrained dragging
            if (event.sourceEvent?.shiftKey) {
                // Remove shift hint
                helperLayer.selectAll('text').remove();

                // Determine dominant direction from start of drag
                const deltaX = Math.abs(newX - d.origX);
                const deltaY = Math.abs(newY - d.origY);

                if (deltaX > deltaY) {
                    newY = d.origY; // Constrain to horizontal
                } else {
                    newX = d.origX; // Constrain to vertical
                }
            }

            // Constrain to graph bounds
            const nodeWidth = d.x1 - d.x0;
            const nodeHeight = d.y1 - d.y0;
            newX = Math.max(1, Math.min(width - nodeWidth - 1, newX));
            newY = Math.max(1, Math.min(height - nodeHeight - 1, newY));

            // Calculate offset from original position
            const dx = newX - d.origX;
            const dy = newY - d.origY;

            // Update node data position
            d.x0 = newX;
            d.x1 = newX + nodeWidth;
            d.y0 = newY;
            d.y1 = newY + nodeHeight;

            // Apply transform to the node group
            d3.select(this)
                .attr('transform', `translate(${dx},${dy})`);

            // Recalculate and redraw links
            sankey.update(graph);
            linksGroup.selectAll('path')
                .attr('d', d3.sankeyLinkHorizontal());

            // Update label position
            labelsGroup.selectAll('text')
                .filter(n => n === d)
                .attr('x', d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr('y', (d.y1 + d.y0) / 2);
        }

        function dragEnded(event, d) {
            // Clean up helpers
            helperLayer.selectAll('*').remove();

            // Update original position to current position (makes this the new "home")
            d.origX = d.x0;
            d.origY = d.y0;
            d.lastX = d.x0;
            d.lastY = d.y0;

            // Remove transform since we've made this the new origin
            d3.select(this).attr('transform', null);

            // Update the rect to the new position
            d3.select(this).select('rect')
                .attr('x', d.x0)
                .attr('y', d.y0);

            // Final relayout
            sankey.update(graph);
            linksGroup.selectAll('path')
                .attr('d', d3.sankeyLinkHorizontal());

            // Update all labels
            labelsGroup.selectAll('text')
                .attr('x', n => n.x0 < width / 2 ? n.x1 + 6 : n.x0 - 6)
                .attr('y', n => (n.y1 + n.y0) / 2);
        }

        // Double-click to reset to original position
        function doubleClicked(event, d) {
            const nodeWidth = d.x1 - d.x0;
            const nodeHeight = d.y1 - d.y0;

            // Reset to true original position
            d.x0 = d.trueOrigX;
            d.y0 = d.trueOrigY;
            d.x1 = d.trueOrigX + nodeWidth;
            d.y1 = d.trueOrigY + nodeHeight;
            d.origX = d.trueOrigX;
            d.origY = d.trueOrigY;
            d.lastX = d.trueOrigX;
            d.lastY = d.trueOrigY;

            // Find the node group and update its rect position
            nodesGroup.selectAll('g')
                .filter(n => n === d)
                .attr('transform', null)
                .select('rect')
                .attr('x', d.x0)
                .attr('y', d.y0);

            // Update layout and labels
            sankey.update(graph);
            linksGroup.selectAll('path').attr('d', d3.sankeyLinkHorizontal());
            labelsGroup.selectAll('text')
                .attr('x', n => n.x0 < width / 2 ? n.x1 + 6 : n.x0 - 6)
                .attr('y', n => (n.y1 + n.y0) / 2);
        }

        // Add draggable node groups
        const nodesGroup = svg.append('g')
            .attr('id', 'nodes-group');

        const nodeElements = nodesGroup
            .selectAll('g')
            .data(graph.nodes)
            .join('g')
            .attr('class', 'node')
            .attr('cursor', 'move')
            .call(d3.drag()
                .on('start', dragStarted)
                .on('drag', dragged)
                .on('end', dragEnded))
            .on('dblclick', doubleClicked);

        // Add node rectangles
        nodeElements.append('rect')
            .attr('x', d => d.x0)
            .attr('y', d => d.y0)
            .attr('height', d => d.y1 - d.y0)
            .attr('width', d => d.x1 - d.x0)
            .attr('fill', d => d.color || color(d.name))
            .attr('opacity', 0.8)
            .attr('stroke', '#fff')
            .attr('stroke-width', 1)
            .append('title')
            .text(d => `${d.name}\n${d.value}\n\nDrag to move • Shift+drag for straight lines • Double-click to reset`);

        // Add labels
        const labelsGroup = svg.append('g')
            .attr('id', 'labels-group')
            .style('font', '12px sans-serif')
            .style('pointer-events', 'none');

        labelsGroup
            .selectAll('text')
            .data(graph.nodes)
            .join('text')
            .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
            .attr('y', d => (d.y1 + d.y0) / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
            .text(d => d.name)
            .append('tspan')
            .attr('fill-opacity', 0.7)
            .text(d => ` ${d.value}`);

    } catch (e) {
        errorText.textContent = e.message;
        errorDiv.classList.remove('d-none');
        preview.innerHTML = `
            <div class="text-muted py-5">
                <i class="bi bi-exclamation-circle display-4 text-danger"></i>
                <p class="mt-3">Unable to render diagram</p>
            </div>
        `;
    }
}

// Auto-render on input (with debounce)
document.getElementById('diagram-config').addEventListener('input', function() {
    clearTimeout(renderTimeout);
    renderTimeout = setTimeout(renderDiagram, 1000);
});

// Save form handler
document.getElementById('save-diagram-form').addEventListener('submit', function(e) {
    const config = document.getElementById('diagram-config').value.trim();

    if (!config) {
        e.preventDefault();
        alert('Please enter a diagram configuration before saving.');
        return false;
    }

    // Copy config to hidden input
    document.getElementById('config-text-input').value = config;

    // Get settings
    const settings = {
        size: document.getElementById('diagram-size').value,
        layout: document.getElementById('diagram-layout').value
    };
    document.getElementById('settings-json-input').value = JSON.stringify(settings);
});

// Download SVG
function downloadSVG() {
    const svg = document.querySelector('#diagram-preview svg');
    if (!svg) {
        alert('Please render a diagram first');
        return;
    }

    const svgData = new XMLSerializer().serializeToString(svg);
    const blob = new Blob([svgData], {type: 'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = (document.getElementById('diagram-name').value || 'sankey-diagram') + '.svg';
    link.click();
    URL.revokeObjectURL(url);
}

// Download PNG
function downloadPNG() {
    const svg = document.querySelector('#diagram-preview svg');
    if (!svg) {
        alert('Please render a diagram first');
        return;
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const svgData = new XMLSerializer().serializeToString(svg);
    const img = new Image();

    const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);

    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        canvas.toBlob(function(blob) {
            const pngUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = pngUrl;
            link.download = (document.getElementById('diagram-name').value || 'sankey-diagram') + '.png';
            link.click();
            URL.revokeObjectURL(pngUrl);
            URL.revokeObjectURL(url);
        });
    };

    img.src = url;
}

// Initial render if editing
{% if diagram %}
document.addEventListener('DOMContentLoaded', function() {
    renderDiagram();
});
{% endif %}
</script>
{% endblock %}
